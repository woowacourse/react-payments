## 💡 커밋 링크

- [refactor: useCardValidation 훅을 Context API로 리팩토링](https://github.com/sooyeoniya/react-payments/commit/7a76724d9a6e95a00e0b3bee9bc46dc5dc64c5fb)

## 💡 문제 상황

### **1️⃣ `Preview` 컴포넌트 관련 이슈: Preview 컴포넌트 내부에서도 에러 상태가 필요하다.**

카드 번호가 16자가 입력되면, 아무리 입력 값이 에러여도 Preview에서 카드 타입(visa, master)이 식별되어 화면에 보여지고 있었습니다. </br>
입력 값 자체가 유효하지 않아 에러가 뜨는데, 이때 카드 타입 Preview에 뜨게 되면 UX 적으로 이상하다고 생각했습니다. </br>
그렇기 때문에 에러일 때 화면에 카드 타입이 보이지 않기 위해서 Preview 컴포넌트 내부에서도 입력값의 에러 상태가 필요해졌습니다.

그런데, 에러 상태를 관리하는 useCardValidation 훅은 CardFormSection 내부에서만 생성을 해주고 있어서 더 상위 컴포넌트에서 useCardValidation 훅을 생성하여 상태를 Props로 내려주어야 했습니다. </br>
이렇게 하면 useCard 훅(useContext를 사용해 카드 정보를 관리하는 훅)과 동일한 위치에 존재하게 됩니다. </br>
또한, 커스텀 훅을 사용하든 Context API를 사용하든 결국 같은 트리 깊이에서 하위로 전달되기 때문에, 실질적인 차이는 없다고 판단했습니다.

따라서, 지금과 같은 커스텀 훅이 아닌, useContext 훅으로 바꾸어서 상태를 접근해주는 것이 Props도 줄어들어서 훨씬 내부적으로 로직이 깔끔해지지 않을까 하는 생각이 들었습니다.

### **2️⃣ `CardFormSection` 스토리북 관련 이슈: 에러 상태인 UI를 테스트할 수 없다.**

기존 Storybook을 보면 에러가 발생했을 때 Error 메시지가 보이는 UI를 테스트하고 있지 않습니다. </br>
하지만 저는 CardFormSection의 스토리북에서 각 폼 별로 에러가 발생한 UI 상태를 Storybook에서 재현하고 싶었습니다.

따라서 처음에는 아래와 같이 유효하지 않은 값을 넣어주었는데, Storybook에서 에러가 전혀 발생하지 않아서 에러 UI를 테스트할 수 없었습니다.

```tsx
// 카드 번호 폼에서 에러가 발생한 경우를 재현하기
export const CardNumbersWithError: Story = {
  decorators: [
    withCustomCardProvider({
      cardNumbers: {
        first: "가나다라", // 이렇게 해도 에러 UI를 확인할 수 없음
        second: "",
        third: "",
        fourth: "",
      },
    }),
  ],
  args: {
    type: CARD_FORM_TYPE.cardNumbers,
  },
};
```

여기서 에러가 발생하지 않는 이유는 제 코드 구조 상의 흐름 때문이었는데요.

- 에러 상태는 `input의 onChange → validate 호출 → state 변경` 흐름으로만 발생한다.
- 즉, 위와 같이 context의 value만 바꿔준다고 해도, 에러는 절대 발생하지 않는다.

만약 이를 실현시켜주기 위해서는 두 가지 방식이 존재했습니다.

1.  **`CardContext` 내부에 유효성 검증하는 로직을 추가한다.**

    ```
    이는 현재 전체 카드 정보를 관리하는 CardContext 에서 state를 업데이트 해줄 때 같이 유효성 검증을 해주는 방법입니다.
    하지만, 유효성 검증 로직은 전부 useCardValidation 훅이 가지고 있기 때문에 훅 내부에서 훅을 호출하기에는 관심사 분리가 제대로 되지 않아서 좋아보이지는 않았습니다.

    또는 아예 이렇게 두 개의 훅을 하나의 훅으로 합쳐야 하는데, 이렇게 되면 상태 관리와 유효성 검증 로직이 합쳐지기 때문에 너무 많은 일을 하나의 훅이 담당하게 되었습니다.
    그래서 좋지 않은 방식이라고 생각했습니다.
    ```

2.  **`useCardValidation` 훅을 지금처럼 커스텀 훅이 아닌 `useContext` 훅으로 변경한다.**

    ```
    useCardValidation 훅은 useState를 내부에서 쓰고 있어서, 외부에서 상태를 조작할 방법이 직접적으로는 없었습니다.
    그렇다고 Storybook 내부에 useCardValidation 을 직접 호출하면 React 규칙 위반으로 에러 발생합니다.

    또한, CardFormSection 컴포넌트에서는 Props로 전달된 type 값만 직접 조작 가능하기 때문에, 직접 Input 내부 내용을 작성할 수 없어서 에러를 발생시킬 수 없습니다.
    (만약 이 상태로 실현 가능하게 하려면 하려면 Storybook의 기능 중 하나인 play function을 사용해 직접 인터렉션을 구현해야 합니다.)

    결론적으로, 유효성 검증하는 로직을 직접 조작할 수 있도록 하려면, useCardValidation 훅을 직접 조작하는 Provider를 별도로 만들어야 했습니다.
    useContext를 사용해서 CardValidationContext 훅을 만들고, 이를 사용하는 Provider로 분리해서 Storybook의 decorator에서 value를 주입해줄 수 있게 구조를 잡는 것이 이를 실현할 수 있는 방법 중 하나였습니다.
    ```

위와 같은 고민들을 기반으로, `Context API`로 변경하면 어떨지 고민했습니다.
이 과정에서 제가 생각한 `커스텀 훅`과 `Context API`의 각각의 장단점을 적어보고, 해당 미션에서 더 나은 방식이 무엇인지 결정해보았습니다.

1.  **커스텀 훅의 장점:** Props로 어떤 값을 넘겨주는지 직관적으로 파악이 가능하여, 상태의 흐름을 좀 더 확실히 파악할 수 있다. 리렌더링의 범위가 Context API보다 작아서 훨씬 성능 측면에서 이점이 있다. (하지만 현재 상황에서는 렌더링과 관련하여 Context API나 커스텀 훅을 사용하더라도 두 가지 방식 모두 동일한 컴포넌트들(상태 관련된 컴포넌트들)이 리렌더링된다. 어차피, styled-components로 만든 컴포넌트의 경우에는 최적화되어 있어서 불필요한 리렌더링을 발생시키지 않는다.)
2.  **Context API의 장점:** Props를 줄일 수 있어서 내부 로직이 훨씬 깔끔해지고, 필요한 컴포넌트에서 필요한 상태만 호출해 사용해줄 수 있다.

3.  **커스텀 훅의 단점:** 커스텀 훅을 호출하는 상위 컴포넌트에서는 하위 컴포넌트에 필요한 모든 상태들을 전부 꺼내서 Props로 내려줘야 한다. 그래서 상위 컴포넌트 내부에서 불러오는 변수들이 너무 많아지고, 코드가 너무 길어져서 복잡해진다. 따라서 해당 상위 컴포넌트에서만 직접적으로 사용하는 변수가 무엇인지 한 눈에 파악하기 어렵다.
4.  **Context API의 단점:** Props로 전달받지 않기 때문에, 해당 상태들의 흐름을 한 눈에 파악하기 어렵다.

제가 생각한 장단점은 위와 같았습니다.

결론적으로, 저는 useCardValidation 훅에 대하여 `Context API` 방식을 선택하기로 했습니다. </br>
useContext 훅을 사용하면 내부 로직이 훨씬 깔끔해질 수 있기 때문입니다.

또한, useCard 훅과 비슷한 상황임에도 이는 Context API를, 다른 하나(useCardValidation 훅)는 커스텀 훅을 사용하는 것은 일관성이 떨어진다고 판단했습니다.

저는 전역 상태 관리라고 해서 무조건 지양해야 한다고는 생각하지 않습니다. </br>
이번 미션에서는 상태 관점을 "하나의 페이지 단위"가 아니라, "카드 등록"이라는 모듈 단위로 접근하는 것이 더 적절하다고 느꼈습니다. </br>
왜냐하면, 페이지 자체에는 여러 다른 상태를 관리하는 모듈들이 존재하는 것이 아니라 카드를 등록하는 모듈 단위의 상태만 존재하기 때문입니다. </br>
이렇게 보면, 전역 상태라기보다는 모듈 범위 내에서 상태를 관리한다는 의미에 가깝습니다.

현재 상황에서는 카드 폼에서 입력한 상태들을 Preview 컴포넌트에서도 모두 공유해야 하기 때문에, 상태들을 한 번에 묶어서 관리하는 것이 더 자연스럽다고 판단했습니다. </br>
이미 구조적으로도 그렇게 되어 있기 때문에, 커스텀 훅을 사용하든 Context API를 사용하든 어차피 상태 관리는 모두 한 번에 이뤄집니다.

정리하면,

> 상태를 많은 컴포넌트가 공유하거나 혹은 깊은 트리에 걸쳐 있다면 → Context 사용
>
> 부분 상태만 사용하는 컴포넌트가 많고 렌더링 비용이 민감하다면 → 커스텀 훅 + props 전달

## 💡 결론

- CardFormSection 컴포넌트 내부가 훨씬 간결해졌습니다.
- Preview 컴포넌트에서도 useCardValidation 훅을 호출해 사용할 수 있게 되었습니다.
- CardFormSection Storybook에서 에러 상태인 UI를 테스트할 수 있게 되었습니다.
- 모듈 단위의 상태를 좀 더 효율적으로 관리할 수 있게 되었습니다.
